import { Canvas, Webtable, Webview } from 'maxwhere';
import womAsync from '../wrappers/womAsync.module';
import sleep from './sleep';
/**
 * Opens devtools for the specified webview and refreshes on "F5"
 * @param ww Webview/Webtabel to open devtools
 * @param initHandler callback function to run after refresh
 */
export default function browserDevMode(
  ww: Webview | Webtable,
  initHandler?: (webview: Webview) => any,
) {
  let webview: Webview;
  if ((ww as Webtable).webview) {
    webview = (ww as Webtable).webview;
  } else {
    webview = ww as Webview;
  }

  webview.browserWindow.webContents.openDevTools({ mode: 'detach' });

  //reload overlay on F5
  womAsync.selfAwareListener(
    'input-keyboard',
    async (event) => {
      if (event.keyName == 'F5' && event.type == 'keyDown') {
        // we have to close devtools and reopen, otherwise the reload is buggy
        webview.browserWindow.webContents.closeDevTools();
        await sleep(1000);
        webview.browserWindow.reload();
        await sleep(1000);
        webview.browserWindow.webContents.openDevTools({ mode: 'detach' });
        if (initHandler) {
          initHandler(webview);
        }
      }
    },
    webview,
  );
}
